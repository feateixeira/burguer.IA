# üîß Como Corrigir a Edge Function create-user

## ‚ö†Ô∏è PROBLEMA IDENTIFICADO

A Edge Function `create-user` no Supabase Dashboard est√° com o c√≥digo **ERRADO** - est√° usando o c√≥digo da fun√ß√£o `verify-admin-password`!

Isso explica o erro: a fun√ß√£o est√° recebendo dados de cria√ß√£o de usu√°rio (`email`, `password`, `name`, `establishmentName`) mas est√° tentando processar como se fosse verifica√ß√£o de senha admin.

## ‚úÖ SOLU√á√ÉO

### Passo 1: Abrir a Edge Function no Supabase

1. Acesse [Supabase Dashboard](https://supabase.com/dashboard)
2. Selecione seu projeto
3. V√° em **Edge Functions** (menu lateral)
4. Encontre e clique em **`create-user`**

### Passo 2: Substituir o C√≥digo

1. Clique em **Edit** ou no √≠cone de edi√ß√£o
2. **DELETE TODO O C√ìDIGO ATUAL**
3. **COPIE O C√ìDIGO CORRETO** do arquivo `CODIGO_CREATE_USER_CORRETO.txt`
4. Cole o c√≥digo novo
5. Clique em **Save** ou **Deploy**

### Passo 3: Verificar Vari√°veis de Ambiente

A Edge Function precisa das seguintes vari√°veis:

1. No Supabase Dashboard, v√° em **Edge Functions** ‚Üí **`create-user`**
2. Clique em **Settings** ou procure por **Secrets/Environment Variables**
3. Certifique-se de que existem:
   - `SUPABASE_URL` (j√° deve existir automaticamente)
   - `SUPABASE_SERVICE_ROLE_KEY` ‚ö†Ô∏è **IMPORTANTE**: Precisa ser a SERVICE_ROLE_KEY, n√£o a ANON_KEY!

Para obter a SERVICE_ROLE_KEY:
- V√° em **Settings** ‚Üí **API**
- Copie a **`service_role` secret key** (n√£o a `anon` public key!)
- Adicione como vari√°vel de ambiente na Edge Function

### Passo 4: Testar

1. Fa√ßa login como admin no painel
2. Tente criar um novo usu√°rio
3. Deve funcionar agora! ‚úÖ

## üîç Diferen√ßas entre os C√≥digos

### C√≥digo ERRADO (que est√° l√° agora):
- Usa `SUPABASE_ANON_KEY` 
- Espera apenas `password` no body
- Faz `bcrypt.compare()` para verificar senha
- N√£o cria usu√°rios

### C√≥digo CORRETO:
- Usa `SUPABASE_SERVICE_ROLE_KEY` (bypassa RLS)
- Espera `email`, `password`, `name`, `establishmentName`
- Cria usu√°rio com `auth.admin.createUser()`
- Cria profile e establishment automaticamente

## ‚ö†Ô∏è Aten√ß√£o

Se a fun√ß√£o `create-user` n√£o existir:
1. Crie uma nova Edge Function chamada `create-user`
2. Cole o c√≥digo correto
3. Configure as vari√°veis de ambiente

## üìã Checklist

- [ ] Edge Function `create-user` existe no Supabase
- [ ] C√≥digo foi substitu√≠do pelo c√≥digo correto
- [ ] Vari√°vel `SUPABASE_URL` est√° configurada
- [ ] Vari√°vel `SUPABASE_SERVICE_ROLE_KEY` est√° configurada (SERVICE_ROLE, n√£o ANON!)
- [ ] C√≥digo foi salvo/deployed
- [ ] Testou criar usu√°rio no painel admin

## üÜò Se ainda n√£o funcionar

1. Verifique os **Logs** da Edge Function no Supabase Dashboard
2. Abra o **Console do navegador** (F12) e veja mensagens de erro
3. Verifique se o usu√°rio logado √© realmente admin (`is_admin = true`)




