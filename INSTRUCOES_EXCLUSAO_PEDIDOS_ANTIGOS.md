# Instru√ß√µes: Exclus√£o Autom√°tica de Pedidos Antigos

## üìã O que foi implementado

1. **Fun√ß√£o SQL**: `delete_old_orders()` - criada na migration
2. **Edge Function**: `delete-old-orders` - para ser executada periodicamente
3. **Filtro Frontend**: A p√°gina j√° filtra pedidos com mais de 3 meses automaticamente

## üöÄ Passo a Passo no Supabase

### Op√ß√£o 1: Executar Manualmente (Teste Inicial)

1. **Acesse o Supabase Dashboard**
   - V√° em: **SQL Editor** ‚Üí **New Query**

2. **Execute a fun√ß√£o diretamente**:
   ```sql
   SELECT public.delete_old_orders();
   ```

3. **Verifique o resultado**:
   - A fun√ß√£o retorna um JSON com o n√∫mero de pedidos deletados

### Op√ß√£o 2: Configurar Execu√ß√£o Autom√°tica via Edge Function (Recomendado)

#### Passo 1: Fazer deploy da Edge Function

No terminal do seu projeto:

```bash
# Fazer deploy da fun√ß√£o
supabase functions deploy delete-old-orders
```

Ou fa√ßa o deploy manualmente pelo Supabase Dashboard:
- V√° em: **Edge Functions** ‚Üí **Create a new function**
- Nome: `delete-old-orders`
- Cole o conte√∫do do arquivo `supabase/functions/delete-old-orders/index.ts`

#### Passo 2: Configurar Cron Job no Supabase

**M√©todo A - Via Supabase Dashboard (se dispon√≠vel):**
1. V√° em: **Database** ‚Üí **Cron Jobs** (ou **Scheduled Functions**)
2. Crie um novo cron job:
   - **Nome**: `delete-old-orders-daily`
   - **Schedule**: `0 2 * * *` (todo dia √†s 2h da manh√£)
   - **Function**: `delete-old-orders`
   - **HTTP Method**: `POST`

**M√©todo B - Via pg_cron (requer acesso ao banco):**
1. No **SQL Editor**, execute:
```sql
-- Habilitar pg_cron (se ainda n√£o estiver habilitado)
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Criar job para executar diariamente √†s 2h da manh√£
SELECT cron.schedule(
  'delete-old-orders-daily',
  '0 2 * * *',  -- Todo dia √†s 2h da manh√£ (formato: minuto hora dia m√™s dia-da-semana)
  $$
  SELECT net.http_post(
    url := 'https://tndiwjznitnualtorbpk.supabase.co/functions/v1/delete-old-orders',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer SEU_SERVICE_ROLE_KEY_AQUI'
    )
  );
  $$
);
```

**M√©todo C - Via Servi√ßo Externo (GitHub Actions, Vercel Cron, etc.):**
- Configure um webhook/cron job externo para chamar:
  ```
  POST https://tndiwjznitnualtorbpk.supabase.co/functions/v1/delete-old-orders
  Headers:
    Authorization: Bearer SEU_SERVICE_ROLE_KEY
  ```

#### Passo 3: Testar a Edge Function

No **Supabase Dashboard**:
1. V√° em: **Edge Functions** ‚Üí **delete-old-orders** ‚Üí **Invoke**
2. Clique em **Invoke Function**
3. Verifique os logs para confirmar a execu√ß√£o

### Op√ß√£o 3: Usar Vercel Cron (Se o projeto estiver no Vercel)

Crie um arquivo `vercel.json` na raiz do projeto:

```json
{
  "crons": [{
    "path": "/api/cron/delete-old-orders",
    "schedule": "0 2 * * *"
  }]
}
```

E crie a rota `api/cron/delete-old-orders.ts` (se for Next.js) ou configure um webhook.

## ‚úÖ Verifica√ß√£o

Para verificar se est√° funcionando:

1. **Ver quantos pedidos ser√£o deletados** (sem deletar):
```sql
SELECT COUNT(*) as total_pedidos_antigos
FROM public.orders
WHERE created_at < NOW() - INTERVAL '3 months';
```

2. **Verificar logs da fun√ß√£o**:
   - No Supabase Dashboard: **Edge Functions** ‚Üí **delete-old-orders** ‚Üí **Logs**

## üìù Importante

- ‚ö†Ô∏è **Backup**: Antes de ativar a exclus√£o autom√°tica, fa√ßa um backup dos dados
- ‚è∞ **Hor√°rio**: Configure para executar em hor√°rio de baixo tr√°fego (recomendado: madrugada)
- üìä **Monitoramento**: Acompanhe os logs para garantir que est√° funcionando corretamente
- üîí **Seguran√ßa**: A Edge Function usa SERVICE_ROLE_KEY (j√° configurada)

## üéØ Resultado Esperado

Ap√≥s configurar:
- ‚úÖ Pedidos com mais de 3 meses ser√£o exclu√≠dos automaticamente
- ‚úÖ A performance do sistema melhorar√° (menos dados para carregar)
- ‚úÖ O frontend j√° n√£o carrega pedidos antigos (implementado no c√≥digo)

